#!/usr/bin/env bash

GUNICORN_WORKERS=${GUNICORN_WORKERS:-4}
GUNICORN_TIMEOUT=${GUNICORN_TIMEOUT:-60}
GUNICORN_WORKER_THREADS=${GUNICORN_WORKER_THREADS:-1}
GUNICORN_WORKER_CONNECTIONS=${GUNICORN_WORKER_CONNECTIONS:-1000}
GUNICORN_WORKER_MAX_REQUESTS=${GUNICORN_WORKER_MAX_REQUESTS:-3000}
GUNICRON_LOG_LEVEL=${GUNICRON_LOG_LEVEL:-info}
GUNICORN_BACKLOG=${GUNICORN_BACKLOG:-2048}

cd /usr/src/taiga-back

set -x
exec gunicorn \
  --workers="${GUNICORN_WORKERS}" \
  --timeout="${GUNICORN_TIMEOUT}" \
  -b 127.0.0.1:8000 \
  taiga.wsgi \
  --capture-output \
  --threads="${GUNICORN_WORKER_THREADS}" \
  --max-requests="${GUNICORN_WORKER_MAX_REQUESTS}" \
  --worker-connections="${GUNICORN_WORKER_CONNECTIONS}" \
  --log-level="${GUNICRON_LOG_LEVEL}" \
  --backlog="${GUNICORN_BACKLOG}"
